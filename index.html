<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draw & Guess - Multiplayer Drawing Game</title>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Pusher -->
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  
  <!-- React and Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Simple icon components
    const Palette = () => <span>üé®</span>;
    const Eraser = () => <span>üßπ</span>;
    const Trash2 = () => <span>üóëÔ∏è</span>;
    const Check = () => <span>‚úì</span>;
    const MessageCircle = () => <span>üí¨</span>;

    // Pusher configuration
    const PUSHER_KEY = '2b106a71a8bd331695b6';
    const PUSHER_CLUSTER = 'us2';

    // Word bank for the game
    const WORD_BANK = [
      'cat', 'house', 'car', 'tree', 'sun', 'moon', 'star', 'flower', 'pizza', 'burger',
      'phone', 'laptop', 'guitar', 'drum', 'camera', 'book', 'mountain', 'ocean', 'fish',
      'bird', 'dog', 'bicycle', 'airplane', 'rocket', 'cloud', 'rainbow', 'umbrella',
      'crown', 'heart', 'diamond', 'key', 'lock', 'glasses', 'hat', 'shoe', 'shirt',
      'pants', 'coffee', 'cake', 'ice cream', 'apple', 'banana', 'strawberry', 'watermelon'
    ];

    const COLORS = [
      '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', 
      '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080'
    ];

    const DrawingGame = () => {
      const canvasRef = useRef(null);
      const pusherRef = useRef(null);
      const channelRef = useRef(null);
      
      const [isDrawing, setIsDrawing] = useState(false);
      const [currentColor, setCurrentColor] = useState('#000000');
      const [brushSize, setBrushSize] = useState(3);
      const [playerName, setPlayerName] = useState('');
      const [roomCode, setRoomCode] = useState('');
      const [isInGame, setIsInGame] = useState(false);
      const [isDrawer, setIsDrawer] = useState(false);
      const [currentWord, setCurrentWord] = useState('');
      const [guess, setGuess] = useState('');
      const [messages, setMessages] = useState([]);
      const [score, setScore] = useState({ player1: 0, player2: 0 });
      const [showColorPicker, setShowColorPicker] = useState(false);
      const [gameStarted, setGameStarted] = useState(false);
      const [roundTime, setRoundTime] = useState(60);
      const [isEraser, setIsEraser] = useState(false);
      const [connectedPlayers, setConnectedPlayers] = useState(1);

      // Initialize Pusher
      useEffect(() => {
        if (!isInGame) return;

        console.log('Initializing Pusher for room:', roomCode);
        
        // Initialize Pusher
        pusherRef.current = new Pusher(PUSHER_KEY, {
          cluster: PUSHER_CLUSTER
        });

        // Subscribe to the room channel
        const channelName = `game-${roomCode}`;
        channelRef.current = pusherRef.current.subscribe(channelName);

        console.log('Subscribed to channel:', channelName);

        // Listen for drawing events
        channelRef.current.bind('drawing', function(data) {
          console.log('Received drawing event:', data);
          handleRemoteDrawing(data);
        });

        // Listen for guess events
        channelRef.current.bind('guess', function(data) {
          console.log('Received guess:', data);
          const newMessage = {
            player: data.playerName,
            text: data.guess,
            isCorrect: data.isCorrect,
            timestamp: Date.now()
          };
          setMessages(prev => [...prev, newMessage]);
          
          if (data.isCorrect && !isDrawer) {
            setTimeout(() => switchRoles(), 2000);
          }
        });

        // Listen for role switch events
        channelRef.current.bind('switch-roles', function(data) {
          console.log('Received role switch:', data);
          setIsDrawer(data.newDrawer === playerName);
          setCurrentWord(data.newWord);
          clearCanvas();
          setRoundTime(60);
          setMessages([]);
        });

        // Listen for player join events
        channelRef.current.bind('player-joined', function(data) {
          console.log('Player joined:', data);
          setConnectedPlayers(prev => prev + 1);
        });

        // Broadcast that this player joined
        broadcastEvent('player-joined', { playerName });

        return () => {
          if (channelRef.current) {
            channelRef.current.unbind_all();
            pusherRef.current.unsubscribe(`game-${roomCode}`);
          }
          if (pusherRef.current) {
            pusherRef.current.disconnect();
          }
        };
      }, [isInGame, roomCode]);

      const broadcastEvent = async (eventName, data) => {
        const channelName = `game-${roomCode}`;
        
        try {
          const response = await fetch('/api/pusher', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              channel: channelName,
              event: eventName,
              data: data
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to broadcast event');
          }
          
          console.log('Event broadcast:', eventName, data);
        } catch (error) {
          console.error('Error broadcasting event:', error);
          // Fallback to localStorage for local testing
          window.localStorage.setItem(`${channelName}_${eventName}`, JSON.stringify({
            ...data,
            timestamp: Date.now()
          }));
        }
      };

      const handleRemoteDrawing = (data) => {
        if (isDrawer) return; // Don't apply remote drawing if you're the drawer
        
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        if (data.type === 'clear') {
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else if (data.type === 'start') {
          ctx.beginPath();
          ctx.moveTo(data.x, data.y);
        } else if (data.type === 'draw') {
          ctx.strokeStyle = data.isEraser ? '#FFFFFF' : data.color;
          ctx.lineWidth = data.isEraser ? data.size * 3 : data.size;
          ctx.lineCap = 'round';
          ctx.lineTo(data.x, data.y);
          ctx.stroke();
        } else if (data.type === 'stop') {
          ctx.closePath();
        }
      };

      // Canvas drawing logic
      const startDrawing = (e) => {
        if (!isDrawer || !gameStarted) return;
        e.preventDefault();
        
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);

        broadcastEvent('drawing', { type: 'start', x, y, playerName });
      };

      const draw = (e) => {
        if (!isDrawing || !isDrawer || !gameStarted) return;
        
        e.preventDefault();
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = isEraser ? '#FFFFFF' : currentColor;
        ctx.lineWidth = isEraser ? brushSize * 3 : brushSize;
        ctx.lineCap = 'round';
        ctx.lineTo(x, y);
        ctx.stroke();

        broadcastEvent('drawing', { 
          type: 'draw', 
          x, 
          y, 
          color: currentColor, 
          size: brushSize, 
          isEraser,
          playerName 
        });
      };

      const stopDrawing = () => {
        if (!isDrawer) return;
        setIsDrawing(false);
        broadcastEvent('drawing', { type: 'stop', playerName });
      };

      const clearCanvas = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (isDrawer) {
          broadcastEvent('drawing', { type: 'clear', playerName });
        }
      };

      const submitGuess = () => {
        if (!guess.trim()) return;
        
        const isCorrect = guess.toLowerCase().trim() === currentWord.toLowerCase();
        
        const newMessage = {
          player: playerName,
          text: guess,
          isCorrect,
          timestamp: Date.now()
        };
        
        setMessages(prev => [...prev, newMessage]);
        setGuess('');

        // Broadcast the guess
        broadcastEvent('guess', {
          playerName,
          guess: guess.trim(),
          isCorrect
        });

        if (isCorrect) {
          const points = Math.max(10, Math.floor(roundTime / 2));
          setScore(prev => ({
            ...prev,
            [isDrawer ? 'player1' : 'player2']: prev[isDrawer ? 'player1' : 'player2'] + points
          }));
          setTimeout(() => switchRoles(), 2000);
        }
      };

      const switchRoles = () => {
        const newWord = WORD_BANK[Math.floor(Math.random() * WORD_BANK.length)];
        const newDrawer = !isDrawer;
        
        setIsDrawer(newDrawer);
        setCurrentWord(newWord);
        clearCanvas();
        setRoundTime(60);
        setMessages([]);
        
        // Broadcast role switch
        broadcastEvent('switch-roles', {
          newDrawer: newDrawer ? playerName : 'other',
          newWord
        });
      };

      const startGame = () => {
        if (!roomCode || !playerName) return;
        
        console.log('Starting game...');
        setIsInGame(true);
        setGameStarted(true);
        
        // Randomly assign drawer role
        const isFirstPlayer = Math.random() > 0.5;
        setIsDrawer(isFirstPlayer);
        
        const word = WORD_BANK[Math.floor(Math.random() * WORD_BANK.length)];
        setCurrentWord(word);
        
        console.log('Game started! Is drawer:', isFirstPlayer, 'Word:', word);
      };

      // Timer effect
      useEffect(() => {
        if (!gameStarted || roundTime <= 0) return;
        
        const timer = setInterval(() => {
          setRoundTime(prev => {
            if (prev <= 1) {
              switchRoles();
              return 60;
            }
            return prev - 1;
          });
        }, 1000);

        return () => clearInterval(timer);
      }, [gameStarted, roundTime]);

      // Initialize canvas
      useEffect(() => {
        if (canvasRef.current && isInGame) {
          console.log('Initializing canvas...');
          const canvas = canvasRef.current;
          const container = canvas.parentElement;
          
          canvas.width = container.offsetWidth - 20;
          canvas.height = 400;
          
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          console.log('Canvas initialized:', canvas.width, 'x', canvas.height);
        }
      }, [isInGame]);

      if (!isInGame) {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            fontFamily: "'Quicksand', sans-serif"
          }}>
            <div style={{
              background: 'white',
              borderRadius: '24px',
              padding: '40px',
              maxWidth: '400px',
              width: '100%',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              <h1 style={{
                fontSize: '2.5rem',
                fontWeight: '800',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                marginBottom: '10px',
                textAlign: 'center'
              }}>
                ‚úèÔ∏è Draw & Guess
              </h1>
              <p style={{
                textAlign: 'center',
                color: '#64748b',
                marginBottom: '30px',
                fontSize: '0.95rem'
              }}>
                Play with your partner in real-time!
              </p>
              
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontWeight: '600',
                  color: '#334155',
                  fontSize: '0.9rem'
                }}>
                  Your Name
                </label>
                <input
                  type="text"
                  value={playerName}
                  onChange={(e) => setPlayerName(e.target.value)}
                  placeholder="Enter your name"
                  style={{
                    width: '100%',
                    padding: '14px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '12px',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'all 0.2s',
                    boxSizing: 'border-box'
                  }}
                />
              </div>

              <div style={{ marginBottom: '30px' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontWeight: '600',
                  color: '#334155',
                  fontSize: '0.9rem'
                }}>
                  Room Code
                </label>
                <input
                  type="text"
                  value={roomCode}
                  onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
                  placeholder="Create or join room"
                  style={{
                    width: '100%',
                    padding: '14px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '12px',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'all 0.2s',
                    textTransform: 'uppercase',
                    boxSizing: 'border-box'
                  }}
                />
                <p style={{
                  fontSize: '0.8rem',
                  color: '#94a3b8',
                  marginTop: '6px',
                  fontStyle: 'italic'
                }}>
                  Share this code with your partner
                </p>
              </div>

              <button
                onClick={startGame}
                disabled={!playerName || !roomCode}
                style={{
                  width: '100%',
                  padding: '16px',
                  background: (!playerName || !roomCode) 
                    ? '#cbd5e1' 
                    : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '12px',
                  fontSize: '1.1rem',
                  fontWeight: '700',
                  cursor: (!playerName || !roomCode) ? 'not-allowed' : 'pointer',
                  transition: 'transform 0.2s',
                  boxShadow: (!playerName || !roomCode) ? 'none' : '0 4px 12px rgba(102, 126, 234, 0.4)'
                }}
              >
                Start Game üéÆ
              </button>
            </div>
          </div>
        );
      }

      return (
        <div style={{
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          padding: '10px',
          fontFamily: "'Quicksand', sans-serif"
        }}>
          {/* Header */}
          <div style={{
            background: 'white',
            borderRadius: '16px',
            padding: '15px 20px',
            marginBottom: '10px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
              <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                padding: '8px 16px',
                borderRadius: '12px',
                fontWeight: '700',
                fontSize: '1.2rem'
              }}>
                {roundTime}s
              </div>
              <div>
                <div style={{ fontSize: '0.8rem', color: '#94a3b8' }}>Room: {roomCode}</div>
                <div style={{ fontSize: '0.7rem', color: '#94a3b8' }}>
                  {connectedPlayers} player{connectedPlayers !== 1 ? 's' : ''}
                </div>
              </div>
            </div>
            <div style={{ textAlign: 'right' }}>
              <div style={{ fontSize: '0.8rem', color: '#94a3b8' }}>Score</div>
              <div style={{ fontWeight: '700', color: '#334155' }}>
                {score.player1} - {score.player2}
              </div>
            </div>
          </div>

          {/* Word display (for drawer only) */}
          {isDrawer && (
            <div style={{
              background: '#fef3c7',
              border: '2px solid #fbbf24',
              borderRadius: '16px',
              padding: '20px',
              marginBottom: '10px',
              textAlign: 'center',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ fontSize: '0.9rem', color: '#92400e', marginBottom: '5px', fontWeight: '600' }}>
                Draw this word:
              </div>
              <div style={{ fontSize: '2rem', fontWeight: '800', color: '#78350f' }}>
                {currentWord}
              </div>
            </div>
          )}

          {/* Canvas */}
          <div style={{
            background: 'white',
            borderRadius: '16px',
            padding: '10px',
            marginBottom: '10px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
          }}>
            <canvas
              ref={canvasRef}
              onMouseDown={startDrawing}
              onMouseMove={draw}
              onMouseUp={stopDrawing}
              onMouseLeave={stopDrawing}
              onTouchStart={startDrawing}
              onTouchMove={draw}
              onTouchEnd={stopDrawing}
              style={{
                width: '100%',
                height: '400px',
                cursor: isDrawer ? 'crosshair' : 'not-allowed',
                borderRadius: '12px',
                touchAction: 'none',
                border: '1px solid #e2e8f0'
              }}
            />
          </div>

          {/* Drawing tools (for drawer only) */}
          {isDrawer && (
            <div style={{
              background: 'white',
              borderRadius: '16px',
              padding: '15px',
              marginBottom: '10px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ display: 'flex', gap: '10px', marginBottom: '15px', flexWrap: 'wrap' }}>
                <button
                  onClick={() => setShowColorPicker(!showColorPicker)}
                  style={{
                    padding: '12px 16px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontWeight: '600',
                    fontSize: '1rem'
                  }}
                >
                  <Palette /> Color
                </button>
                <button
                  onClick={() => setIsEraser(!isEraser)}
                  style={{
                    padding: '12px 16px',
                    background: isEraser ? '#ef4444' : '#f1f5f9',
                    color: isEraser ? 'white' : '#334155',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontWeight: '600',
                    fontSize: '1rem'
                  }}
                >
                  <Eraser /> {isEraser ? 'Erasing' : 'Eraser'}
                </button>
                <button
                  onClick={clearCanvas}
                  style={{
                    padding: '12px 16px',
                    background: '#f1f5f9',
                    color: '#334155',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontWeight: '600',
                    fontSize: '1rem'
                  }}
                >
                  <Trash2 /> Clear
                </button>
              </div>

              {showColorPicker && (
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(5, 1fr)',
                  gap: '10px',
                  marginTop: '10px'
                }}>
                  {COLORS.map(color => (
                    <button
                      key={color}
                      onClick={() => {
                        setCurrentColor(color);
                        setIsEraser(false);
                        setShowColorPicker(false);
                      }}
                      style={{
                        width: '100%',
                        aspectRatio: '1',
                        background: color,
                        border: currentColor === color ? '3px solid #667eea' : '2px solid #e2e8f0',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        transition: 'transform 0.2s'
                      }}
                    />
                  ))}
                </div>
              )}

              <div style={{ marginTop: '15px' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontWeight: '600',
                  color: '#334155',
                  fontSize: '0.9rem'
                }}>
                  Brush Size: {brushSize}px
                </label>
                <input
                  type="range"
                  min="1"
                  max="20"
                  value={brushSize}
                  onChange={(e) => setBrushSize(Number(e.target.value))}
                  style={{
                    width: '100%',
                    accentColor: '#667eea'
                  }}
                />
              </div>
            </div>
          )}

          {/* Guessing interface (for guesser only) */}
          {!isDrawer && (
            <div style={{
              background: 'white',
              borderRadius: '16px',
              padding: '15px',
              marginBottom: '10px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ marginBottom: '15px' }}>
                <div style={{
                  maxHeight: '120px',
                  overflowY: 'auto',
                  marginBottom: '10px',
                  padding: '10px',
                  background: '#f8fafc',
                  borderRadius: '12px'
                }}>
                  {messages.length === 0 ? (
                    <p style={{ color: '#94a3b8', fontSize: '0.9rem', textAlign: 'center' }}>
                      Your guesses will appear here...
                    </p>
                  ) : (
                    messages.map((msg, i) => (
                      <div
                        key={i}
                        style={{
                          padding: '8px 12px',
                          marginBottom: '6px',
                          background: msg.isCorrect ? '#dcfce7' : 'white',
                          border: msg.isCorrect ? '2px solid #22c55e' : '1px solid #e2e8f0',
                          borderRadius: '8px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                      >
                        {msg.isCorrect && <Check />}
                        <span style={{
                          fontWeight: '600',
                          color: '#334155',
                          fontSize: '0.85rem'
                        }}>
                          {msg.player}: {msg.text}
                        </span>
                      </div>
                    ))
                  )}
                </div>
              </div>

              <div style={{ display: 'flex', gap: '10px' }}>
                <input
                  type="text"
                  value={guess}
                  onChange={(e) => setGuess(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && submitGuess()}
                  placeholder="Type your guess..."
                  style={{
                    flex: 1,
                    padding: '14px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '12px',
                    fontSize: '1rem',
                    outline: 'none',
                    boxSizing: 'border-box'
                  }}
                />
                <button
                  onClick={submitGuess}
                  style={{
                    padding: '14px 20px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    fontWeight: '700',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontSize: '1rem'
                  }}
                >
                  <MessageCircle /> Guess
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DrawingGame />);
  </script>
</body>
</html>
