<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draw & Guess - Multiplayer Drawing Game</title>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Pusher -->
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  
  <!-- React and Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Simple icon components
    const Palette = () => <span>üé®</span>;
    const Eraser = () => <span>üßπ</span>;
    const Trash2 = () => <span>üóëÔ∏è</span>;
    const Check = () => <span>‚úì</span>;
    const MessageCircle = () => <span>üí¨</span>;
    const Users = () => <span>üë•</span>;
    const Play = () => <span>‚ñ∂Ô∏è</span>;

    // Pusher configuration
    const PUSHER_KEY = '2b106a71a8bd331695b6';
    const PUSHER_CLUSTER = 'us2';

    // Word bank for the game
    const WORD_BANK = [
      'cat', 'house', 'car', 'tree', 'sun', 'moon', 'star', 'flower', 'pizza', 'burger',
      'phone', 'laptop', 'guitar', 'drum', 'camera', 'book', 'mountain', 'ocean', 'fish',
      'bird', 'dog', 'bicycle', 'airplane', 'rocket', 'cloud', 'rainbow', 'umbrella',
      'crown', 'heart', 'diamond', 'key', 'lock', 'glasses', 'hat', 'shoe', 'shirt',
      'pants', 'coffee', 'cake', 'ice cream', 'apple', 'banana', 'strawberry', 'watermelon'
    ];

    const COLORS = [
      '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', 
      '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080'
    ];

    const DrawingGame = () => {
      const canvasRef = useRef(null);
      const pusherRef = useRef(null);
      const channelRef = useRef(null);
      const isDrawerRef = useRef(false);
      const playerNameRef = useRef('');
      
      const [isDrawing, setIsDrawing] = useState(false);
      const [currentColor, setCurrentColor] = useState('#000000');
      const [brushSize, setBrushSize] = useState(3);
      const [playerName, setPlayerName] = useState('');
      const [roomCode, setRoomCode] = useState('');
      const [gamePhase, setGamePhase] = useState('login'); // 'login', 'lobby', 'playing'
      const [isDrawer, setIsDrawer] = useState(false);
      const [currentWord, setCurrentWord] = useState('');
      const [guess, setGuess] = useState('');
      const [messages, setMessages] = useState([]);
      const [score, setScore] = useState({});
      const [showColorPicker, setShowColorPicker] = useState(false);
      const [roundTime, setRoundTime] = useState(60);
      const [isEraser, setIsEraser] = useState(false);
      const [lobbyPlayers, setLobbyPlayers] = useState([]);
      const [isHost, setIsHost] = useState(false);
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [lastRoundWinner, setLastRoundWinner] = useState(null);
      const [lastRoundPoints, setLastRoundPoints] = useState(0);

      // Keep refs in sync with state
      useEffect(() => {
        isDrawerRef.current = isDrawer;
        console.log('isDrawer updated to:', isDrawer);
      }, [isDrawer]);
      
      useEffect(() => {
        playerNameRef.current = playerName;
      }, [playerName]);

      // Initialize Pusher
      useEffect(() => {
        if (gamePhase === 'login') return;

        console.log('Initializing Pusher for room:', roomCode);
        
        pusherRef.current = new Pusher(PUSHER_KEY, {
          cluster: PUSHER_CLUSTER
        });

        const channelName = `game-${roomCode}`;
        channelRef.current = pusherRef.current.subscribe(channelName);

        console.log('Subscribed to channel:', channelName);

        // Listen for drawing events
        channelRef.current.bind('drawing', function(data) {
          console.log('Received drawing event:', data);
          // Use refs to get current values
          handleRemoteDrawing(data, isDrawerRef.current, playerNameRef.current);
        });

        // Listen for guess events
        channelRef.current.bind('guess', function(data) {
          console.log('Received guess:', data);
          
          // Only add to messages if it's NOT from me (I already added it locally)
          if (data.playerName !== playerName) {
            const newMessage = {
              player: data.playerName,
              text: data.guess,
              isCorrect: data.isCorrect,
              timestamp: Date.now()
            };
            setMessages(prev => [...prev, newMessage]);
          }
          
          // Update score ONLY if someone ELSE guessed correctly (not me)
          if (data.isCorrect && data.playerName !== playerName) {
            setScore(prev => ({
              ...prev,
              [data.playerName]: (prev[data.playerName] || 0) + data.points
            }));
            
            // Show celebration for everyone when someone else guesses
            setLastRoundWinner(data.playerName);
            setLastRoundPoints(data.points);
            
            setTimeout(() => {
              setShowLeaderboard(true);
              
              setTimeout(() => {
                setShowLeaderboard(false);
                setLastRoundWinner(null);
              }, 4000);
            }, 2000);
          }
        });

        // Listen for role switch events
        channelRef.current.bind('switch-roles', function(data) {
          console.log('Received role switch:', data);
          const wasDrawer = isDrawer;
          const willBeDrawer = data.newDrawer === playerName;
          
          setIsDrawer(willBeDrawer);
          setCurrentWord(data.newWord);
          setRoundTime(60);
          setMessages([]);
          
          // Clear and reinitialize canvas after role switch
          setTimeout(() => {
            const canvas = canvasRef.current;
            if (canvas) {
              const ctx = canvas.getContext('2d');
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              console.log('Canvas cleared for new round. I am drawer:', willBeDrawer);
            }
          }, 100);
        });

        // Listen for player join events
        channelRef.current.bind('player-joined', function(data) {
          console.log('Player joined:', data);
          if (data.playerName !== playerName) {
            setLobbyPlayers(prev => {
              if (prev.find(p => p.name === data.playerName)) {
                return prev;
              }
              return [...prev, { name: data.playerName, ready: false }];
            });
            
            // If we're the host in lobby, broadcast that we're the host
            if (gamePhase === 'lobby' && isHost) {
              setTimeout(() => {
                broadcastEvent('host-announcement', { 
                  host: playerName,
                  players: lobbyPlayers
                });
              }, 100);
            }
            
            // If we're already in lobby, send our info back
            if (gamePhase === 'lobby') {
              setTimeout(() => {
                broadcastEvent('player-joined', { playerName });
              }, 100);
            }
          }
        });

        // Listen for host announcements
        channelRef.current.bind('host-announcement', function(data) {
          console.log('Host announcement received:', data);
          if (data.host !== playerName) {
            setIsHost(false);
            // Update player list with host's view
            if (data.players) {
              setLobbyPlayers(prev => {
                const merged = [...prev];
                data.players.forEach(player => {
                  if (!merged.find(p => p.name === player.name)) {
                    merged.push(player);
                  }
                });
                return merged;
              });
            }
          }
        });

        // Listen for lobby state updates
        channelRef.current.bind('lobby-state', function(data) {
          console.log('Received lobby state:', data);
          if (data.players) {
            setLobbyPlayers(prev => {
              const merged = [...prev];
              data.players.forEach(player => {
                if (!merged.find(p => p.name === player.name)) {
                  merged.push(player);
                }
              });
              return merged;
            });
          }
        });

        // Listen for game start events
        channelRef.current.bind('game-start', function(data) {
          console.log('Game starting:', data);
          setGamePhase('playing');
          setIsDrawer(data.drawer === playerName);
          setCurrentWord(data.word);
          setScore(data.initialScores);
        });

        // Broadcast that this player joined
        broadcastEvent('player-joined', { playerName });
        
        // If joining an existing lobby, request current state
        if (gamePhase === 'lobby') {
          setTimeout(() => {
            broadcastEvent('lobby-state', { 
              players: lobbyPlayers,
              requestedBy: playerName 
            });
          }, 200);
        }

        return () => {
          if (channelRef.current) {
            channelRef.current.unbind_all();
            pusherRef.current.unsubscribe(`game-${roomCode}`);
          }
          if (pusherRef.current) {
            pusherRef.current.disconnect();
          }
        };
      }, [gamePhase, roomCode]);

      const broadcastEvent = async (eventName, data) => {
        const channelName = `game-${roomCode}`;
        
        try {
          const response = await fetch('/api/pusher', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              channel: channelName,
              event: eventName,
              data: data
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to broadcast event');
          }
          
          console.log('Event broadcast:', eventName, data);
        } catch (error) {
          console.error('Error broadcasting event:', error);
        }
      };

      const handleRemoteDrawing = (data, currentIsDrawer, currentPlayerName) => {
        console.log('handleRemoteDrawing called:', data.type, 'isDrawer:', currentIsDrawer, 'data.playerName:', data.playerName, 'myName:', currentPlayerName);
        
        if (currentIsDrawer || data.playerName === currentPlayerName) {
          console.log('Ignoring drawing event (I am drawer or it is my own drawing)');
          return;
        }
        
        const canvas = canvasRef.current;
        if (!canvas) {
          console.log('No canvas ref!');
          return;
        }
        
        const ctx = canvas.getContext('2d');
        
        if (data.type === 'clear') {
          console.log('Clearing canvas remotely');
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else if (data.type === 'start') {
          console.log('Starting path at:', data.x, data.y);
          ctx.beginPath();
          // Scale coordinates based on canvas dimensions
          const scaledX = (data.x / data.canvasWidth) * canvas.width;
          const scaledY = (data.y / data.canvasHeight) * canvas.height;
          console.log('Scaled to:', scaledX, scaledY, 'canvas:', canvas.width, canvas.height);
          ctx.moveTo(scaledX, scaledY);
        } else if (data.type === 'draw') {
          // Scale coordinates based on canvas dimensions
          const scaledX = (data.x / data.canvasWidth) * canvas.width;
          const scaledY = (data.y / data.canvasHeight) * canvas.height;
          ctx.strokeStyle = data.isEraser ? '#FFFFFF' : data.color;
          ctx.lineWidth = data.isEraser ? data.size * 3 : data.size;
          ctx.lineCap = 'round';
          ctx.lineTo(scaledX, scaledY);
          ctx.stroke();
          console.log('Drew line to:', scaledX, scaledY);
        } else if (data.type === 'stop') {
          console.log('Stopping path');
          ctx.closePath();
        }
      };

      // Canvas drawing logic
      const startDrawing = (e) => {
        if (!isDrawer || gamePhase !== 'playing') return;
        e.preventDefault();
        
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);

        broadcastEvent('drawing', { 
          type: 'start', 
          x, 
          y, 
          canvasWidth: canvas.width,
          canvasHeight: canvas.height,
          playerName 
        });
      };

      const draw = (e) => {
        if (!isDrawing || !isDrawer || gamePhase !== 'playing') return;
        
        e.preventDefault();
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = isEraser ? '#FFFFFF' : currentColor;
        ctx.lineWidth = isEraser ? brushSize * 3 : brushSize;
        ctx.lineCap = 'round';
        ctx.lineTo(x, y);
        ctx.stroke();

        broadcastEvent('drawing', { 
          type: 'draw', 
          x, 
          y, 
          color: currentColor, 
          size: brushSize, 
          isEraser,
          canvasWidth: canvas.width,
          canvasHeight: canvas.height,
          playerName 
        });
      };

      const stopDrawing = () => {
        if (!isDrawer) return;
        setIsDrawing(false);
        broadcastEvent('drawing', { type: 'stop', playerName });
      };

      const clearCanvas = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (isDrawer) {
          broadcastEvent('drawing', { type: 'clear', playerName });
        }
      };

      const submitGuess = () => {
        if (!guess.trim()) return;
        
        const isCorrect = guess.toLowerCase().trim() === currentWord.toLowerCase();
        const points = isCorrect ? Math.max(100, Math.floor(roundTime * 10)) : 0;
        
        const newMessage = {
          player: playerName,
          text: guess,
          isCorrect,
          timestamp: Date.now()
        };
        
        setMessages(prev => [...prev, newMessage]);
        setGuess('');

        // Broadcast the guess
        broadcastEvent('guess', {
          playerName,
          guess: guess.trim(),
          isCorrect,
          points
        });

        if (isCorrect) {
          setScore(prev => ({
            ...prev,
            [playerName]: (prev[playerName] || 0) + points
          }));
          
          // Show celebration
          setLastRoundWinner(playerName);
          setLastRoundPoints(points);
          
          // Wait for celebration, then show leaderboard
          setTimeout(() => {
            setShowLeaderboard(true);
            
            // After showing leaderboard, switch roles and continue
            setTimeout(() => {
              setShowLeaderboard(false);
              setLastRoundWinner(null);
              switchRoles();
            }, 4000);
          }, 2000);
        }
      };

      const switchRoles = () => {
        const newWord = WORD_BANK[Math.floor(Math.random() * WORD_BANK.length)];
        
        // Get next drawer from lobby players
        const allPlayers = [playerName, ...lobbyPlayers.map(p => p.name)];
        const currentDrawerIndex = allPlayers.findIndex(p => isDrawer && p === playerName);
        const nextDrawerIndex = (currentDrawerIndex + 1) % allPlayers.length;
        const nextDrawer = allPlayers[nextDrawerIndex];
        
        setIsDrawer(nextDrawer === playerName);
        setCurrentWord(newWord);
        clearCanvas();
        setRoundTime(60);
        setMessages([]);
        
        // Broadcast role switch
        broadcastEvent('switch-roles', {
          newDrawer: nextDrawer,
          newWord
        });
      };

      const joinLobby = () => {
        if (!roomCode || !playerName) return;
        
        console.log('Joining lobby...');
        
        // Check if this is a new room (no one has joined yet)
        // We'll determine this by checking if we receive any lobby-state responses
        setIsHost(false); // Default to not host
        setLobbyPlayers([{ name: playerName, ready: true }]);
        setGamePhase('lobby');
        
        // After a short delay, if no one else responded, we're the host
        setTimeout(() => {
          setLobbyPlayers(prev => {
            if (prev.length === 1 && prev[0].name === playerName) {
              console.log('No other players detected, I am the host');
              setIsHost(true);
            }
            return prev;
          });
        }, 1000);
      };

      const startGame = () => {
        if (!isHost) return;
        
        console.log('Starting game...');
        
        const allPlayers = [playerName, ...lobbyPlayers.map(p => p.name).filter(n => n !== playerName)];
        
        if (allPlayers.length < 2) {
          alert('Need at least 2 players to start!');
          return;
        }
        
        // Pick random drawer
        const drawerIndex = Math.floor(Math.random() * allPlayers.length);
        const drawer = allPlayers[drawerIndex];
        const word = WORD_BANK[Math.floor(Math.random() * WORD_BANK.length)];
        
        // Initialize scores
        const initialScores = {};
        allPlayers.forEach(player => {
          initialScores[player] = 0;
        });
        
        setScore(initialScores);
        setIsDrawer(drawer === playerName);
        setCurrentWord(word);
        setGamePhase('playing');
        
        // Broadcast game start
        broadcastEvent('game-start', {
          drawer,
          word,
          initialScores
        });
      };

      // Timer effect
      useEffect(() => {
        if (gamePhase !== 'playing' || roundTime <= 0) return;
        
        const timer = setInterval(() => {
          setRoundTime(prev => {
            if (prev <= 1) {
              switchRoles();
              return 60;
            }
            return prev - 1;
          });
        }, 1000);

        return () => clearInterval(timer);
      }, [gamePhase, roundTime]);

      // Initialize canvas
      useEffect(() => {
        if (canvasRef.current && gamePhase === 'playing') {
          console.log('Initializing canvas...');
          const canvas = canvasRef.current;
          const container = canvas.parentElement;
          
          canvas.width = container.offsetWidth - 20;
          canvas.height = 400;
          
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          console.log('Canvas initialized:', canvas.width, 'x', canvas.height);
        }
      }, [gamePhase]);

      // Login Screen
      if (gamePhase === 'login') {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            fontFamily: "'Quicksand', sans-serif"
          }}>
            <div style={{
              background: 'white',
              borderRadius: '24px',
              padding: '40px',
              maxWidth: '400px',
              width: '100%',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              <h1 style={{
                fontSize: '2.5rem',
                fontWeight: '800',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                marginBottom: '10px',
                textAlign: 'center'
              }}>
                ‚úèÔ∏è Draw & Guess
              </h1>
              <p style={{
                textAlign: 'center',
                color: '#64748b',
                marginBottom: '30px',
                fontSize: '0.95rem'
              }}>
                Play with your friends in real-time!
              </p>
              
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontWeight: '600',
                  color: '#334155',
                  fontSize: '0.9rem'
                }}>
                  Your Name
                </label>
                <input
                  type="text"
                  value={playerName}
                  onChange={(e) => setPlayerName(e.target.value)}
                  placeholder="Enter your name"
                  style={{
                    width: '100%',
                    padding: '14px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '12px',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'all 0.2s',
                    boxSizing: 'border-box'
                  }}
                />
              </div>

              <div style={{ marginBottom: '30px' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontWeight: '600',
                  color: '#334155',
                  fontSize: '0.9rem'
                }}>
                  Room Code
                </label>
                <input
                  type="text"
                  value={roomCode}
                  onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
                  placeholder="Create or join room"
                  style={{
                    width: '100%',
                    padding: '14px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '12px',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'all 0.2s',
                    textTransform: 'uppercase',
                    boxSizing: 'border-box'
                  }}
                />
                <p style={{
                  fontSize: '0.8rem',
                  color: '#94a3b8',
                  marginTop: '6px',
                  fontStyle: 'italic'
                }}>
                  Share this code with your friends
                </p>
              </div>

              <button
                onClick={joinLobby}
                disabled={!playerName || !roomCode}
                style={{
                  width: '100%',
                  padding: '16px',
                  background: (!playerName || !roomCode) 
                    ? '#cbd5e1' 
                    : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '12px',
                  fontSize: '1.1rem',
                  fontWeight: '700',
                  cursor: (!playerName || !roomCode) ? 'not-allowed' : 'pointer',
                  transition: 'transform 0.2s',
                  boxShadow: (!playerName || !roomCode) ? 'none' : '0 4px 12px rgba(102, 126, 234, 0.4)'
                }}
              >
                Join Lobby üö™
              </button>
            </div>
          </div>
        );
      }

      // Lobby Screen
      if (gamePhase === 'lobby') {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            fontFamily: "'Quicksand', sans-serif"
          }}>
            <div style={{
              background: 'white',
              borderRadius: '24px',
              padding: '40px',
              maxWidth: '500px',
              width: '100%',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              <div style={{
                textAlign: 'center',
                marginBottom: '30px'
              }}>
                <h2 style={{
                  fontSize: '2rem',
                  fontWeight: '800',
                  color: '#334155',
                  marginBottom: '10px'
                }}>
                  Game Lobby
                </h2>
                <div style={{
                  display: 'inline-block',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  padding: '12px 24px',
                  borderRadius: '12px',
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  letterSpacing: '2px'
                }}>
                  {roomCode}
                </div>
                <p style={{
                  fontSize: '0.9rem',
                  color: '#94a3b8',
                  marginTop: '10px'
                }}>
                  Share this code with friends to join!
                </p>
              </div>

              <div style={{
                background: '#f8fafc',
                borderRadius: '16px',
                padding: '20px',
                marginBottom: '20px'
              }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px',
                  marginBottom: '15px'
                }}>
                  <Users />
                  <h3 style={{
                    fontSize: '1.2rem',
                    fontWeight: '700',
                    color: '#334155'
                  }}>
                    Players ({lobbyPlayers.length})
                  </h3>
                </div>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  {lobbyPlayers.map((player, i) => (
                    <div key={i} style={{
                      background: 'white',
                      padding: '12px 16px',
                      borderRadius: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      border: '2px solid #e2e8f0'
                    }}>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                      }}>
                        <div style={{
                          width: '40px',
                          height: '40px',
                          borderRadius: '50%',
                          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'white',
                          fontWeight: '700',
                          fontSize: '1.2rem'
                        }}>
                          {player.name.charAt(0).toUpperCase()}
                        </div>
                        <span style={{
                          fontWeight: '600',
                          color: '#334155',
                          fontSize: '1rem'
                        }}>
                          {player.name}
                          {player.name === playerName && ' (You)'}
                        </span>
                      </div>
                      {player.name === playerName && isHost && (
                        <span style={{
                          background: '#fbbf24',
                          color: '#78350f',
                          padding: '4px 12px',
                          borderRadius: '8px',
                          fontSize: '0.8rem',
                          fontWeight: '700'
                        }}>
                          HOST
                        </span>
                      )}
                    </div>
                  ))}
                </div>

                {lobbyPlayers.length < 2 && (
                  <p style={{
                    textAlign: 'center',
                    color: '#94a3b8',
                    fontSize: '0.9rem',
                    marginTop: '15px',
                    fontStyle: 'italic'
                  }}>
                    Waiting for more players to join...
                  </p>
                )}
              </div>

              {isHost && (
                <button
                  onClick={startGame}
                  disabled={lobbyPlayers.length < 2}
                  style={{
                    width: '100%',
                    padding: '16px',
                    background: lobbyPlayers.length < 2
                      ? '#cbd5e1' 
                      : 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    fontSize: '1.1rem',
                    fontWeight: '700',
                    cursor: lobbyPlayers.length < 2 ? 'not-allowed' : 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '10px',
                    boxShadow: lobbyPlayers.length < 2 ? 'none' : '0 4px 12px rgba(34, 197, 94, 0.4)'
                  }}
                >
                  <Play /> Start Game
                </button>
              )}

              {!isHost && (
                <div style={{
                  textAlign: 'center',
                  padding: '16px',
                  background: '#f1f5f9',
                  borderRadius: '12px',
                  color: '#64748b',
                  fontSize: '0.95rem'
                }}>
                  Waiting for host to start the game...
                </div>
              )}
            </div>
          </div>
        );
      }

      // Playing Screen
      return (
        <div style={{
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          padding: '10px',
          fontFamily: "'Quicksand', sans-serif",
          position: 'relative'
        }}>
          {/* Celebration Animation */}
          {lastRoundWinner && !showLeaderboard && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.8)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
              animation: 'fadeIn 0.3s ease-in'
            }}>
              <div style={{
                textAlign: 'center',
                animation: 'bounceIn 0.6s ease-out'
              }}>
                <div style={{
                  fontSize: '6rem',
                  marginBottom: '20px',
                  animation: 'spin 1s ease-in-out'
                }}>
                  üéâ
                </div>
                <h1 style={{
                  fontSize: '3rem',
                  color: 'white',
                  fontWeight: '800',
                  marginBottom: '20px',
                  textShadow: '0 4px 20px rgba(0,0,0,0.5)'
                }}>
                  {lastRoundWinner === playerName ? 'You Got It!' : `${lastRoundWinner} Got It!`}
                </h1>
                <div style={{
                  fontSize: '4rem',
                  color: '#fbbf24',
                  fontWeight: '800',
                  textShadow: '0 4px 20px rgba(0,0,0,0.5)',
                  animation: 'pulse 1s ease-in-out infinite'
                }}>
                  +{lastRoundPoints} pts
                </div>
              </div>
            </div>
          )}

          {/* Leaderboard Modal */}
          {showLeaderboard && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.9)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
              animation: 'fadeIn 0.3s ease-in'
            }}>
              <div style={{
                background: 'white',
                borderRadius: '24px',
                padding: '40px',
                maxWidth: '500px',
                width: '90%',
                boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
                animation: 'slideUp 0.5s ease-out'
              }}>
                <h2 style={{
                  fontSize: '2.5rem',
                  fontWeight: '800',
                  textAlign: 'center',
                  marginBottom: '30px',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  WebkitBackgroundClip: 'text',
                  WebkitTextFillColor: 'transparent'
                }}>
                  üèÜ Leaderboard
                </h2>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                  {Object.entries(score)
                    .sort(([, a], [, b]) => b - a)
                    .map(([player, points], index) => (
                      <div
                        key={player}
                        style={{
                          background: index === 0 
                            ? 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)'
                            : index === 1
                            ? 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)'
                            : index === 2
                            ? 'linear-gradient(135deg, #fb923c 0%, #ea580c 100%)'
                            : '#f1f5f9',
                          padding: '20px',
                          borderRadius: '16px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          boxShadow: index < 3 ? '0 4px 12px rgba(0,0,0,0.2)' : 'none',
                          transform: `scale(${index === 0 ? 1.05 : 1})`,
                          animation: `slideIn ${0.3 + index * 0.1}s ease-out`
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                          <div style={{
                            fontSize: '2rem',
                            fontWeight: '800',
                            color: index < 3 ? 'white' : '#334155',
                            minWidth: '40px'
                          }}>
                            {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`}
                          </div>
                          <div>
                            <div style={{
                              fontSize: '1.3rem',
                              fontWeight: '700',
                              color: index < 3 ? 'white' : '#334155'
                            }}>
                              {player}
                              {player === playerName && ' (You)'}
                            </div>
                          </div>
                        </div>
                        <div style={{
                          fontSize: '1.8rem',
                          fontWeight: '800',
                          color: index < 3 ? 'white' : '#334155'
                        }}>
                          {points}
                        </div>
                      </div>
                    ))}
                </div>

                <p style={{
                  textAlign: 'center',
                  color: '#64748b',
                  fontSize: '0.9rem',
                  marginTop: '30px',
                  fontStyle: 'italic'
                }}>
                  Next round starting soon...
                </p>
              </div>
            </div>
          )}

          <style>
            {`
              @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
              }
              @keyframes bounceIn {
                0% { transform: scale(0.3); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
              }
              @keyframes spin {
                0% { transform: rotate(0deg) scale(0.5); }
                50% { transform: rotate(180deg) scale(1.2); }
                100% { transform: rotate(360deg) scale(1); }
              }
              @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
              }
              @keyframes slideUp {
                from { transform: translateY(100px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
              }
              @keyframes slideIn {
                from { transform: translateX(-50px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
              }
            `}
          </style>
          {/* Header */}
          <div style={{
            background: 'white',
            borderRadius: '16px',
            padding: '15px 20px',
            marginBottom: '10px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
              <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                padding: '8px 16px',
                borderRadius: '12px',
                fontWeight: '700',
                fontSize: '1.2rem'
              }}>
                {roundTime}s
              </div>
              <div>
                <div style={{ fontSize: '0.8rem', color: '#94a3b8' }}>Room: {roomCode}</div>
                <div style={{ fontSize: '0.7rem', color: '#94a3b8' }}>
                  {lobbyPlayers.length} player{lobbyPlayers.length !== 1 ? 's' : ''}
                </div>
              </div>
            </div>
            <div style={{ textAlign: 'right' }}>
              <div style={{ fontSize: '0.8rem', color: '#94a3b8' }}>Your Score</div>
              <div style={{ fontWeight: '700', color: '#334155' }}>
                {score[playerName] || 0}
              </div>
            </div>
          </div>

          {/* Word display (for drawer only) */}
          {isDrawer && (
            <div style={{
              background: '#fef3c7',
              border: '2px solid #fbbf24',
              borderRadius: '16px',
              padding: '20px',
              marginBottom: '10px',
              textAlign: 'center',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ fontSize: '0.9rem', color: '#92400e', marginBottom: '5px', fontWeight: '600' }}>
                üé® Draw this word:
              </div>
              <div style={{ fontSize: '2rem', fontWeight: '800', color: '#78350f' }}>
                {currentWord}
              </div>
            </div>
          )}

          {/* Guesser hint */}
          {!isDrawer && (
            <div style={{
              background: '#dbeafe',
              border: '2px solid #3b82f6',
              borderRadius: '16px',
              padding: '15px',
              marginBottom: '10px',
              textAlign: 'center',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ fontSize: '0.9rem', color: '#1e40af', fontWeight: '600' }}>
                ü§î Guess what's being drawn! ({currentWord.length} letters)
              </div>
            </div>
          )}

          {/* Canvas */}
          <div style={{
            background: 'white',
            borderRadius: '16px',
            padding: '10px',
            marginBottom: '10px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
          }}>
            <canvas
              ref={canvasRef}
              onMouseDown={startDrawing}
              onMouseMove={draw}
              onMouseUp={stopDrawing}
              onMouseLeave={stopDrawing}
              onTouchStart={startDrawing}
              onTouchMove={draw}
              onTouchEnd={stopDrawing}
              style={{
                width: '100%',
                height: '400px',
                cursor: isDrawer ? 'crosshair' : 'default',
                borderRadius: '12px',
                touchAction: 'none',
                border: '1px solid #e2e8f0'
              }}
            />
          </div>

          {/* Drawing tools (for drawer only) */}
          {isDrawer && (
            <div style={{
              background: 'white',
              borderRadius: '16px',
              padding: '15px',
              marginBottom: '10px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ display: 'flex', gap: '10px', marginBottom: '15px', flexWrap: 'wrap' }}>
                <button
                  onClick={() => setShowColorPicker(!showColorPicker)}
                  style={{
                    padding: '12px 16px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontWeight: '600',
                    fontSize: '1rem'
                  }}
                >
                  <Palette /> Color
                </button>
                <button
                  onClick={() => setIsEraser(!isEraser)}
                  style={{
                    padding: '12px 16px',
                    background: isEraser ? '#ef4444' : '#f1f5f9',
                    color: isEraser ? 'white' : '#334155',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontWeight: '600',
                    fontSize: '1rem'
                  }}
                >
                  <Eraser /> {isEraser ? 'Erasing' : 'Eraser'}
                </button>
                <button
                  onClick={clearCanvas}
                  style={{
                    padding: '12px 16px',
                    background: '#f1f5f9',
                    color: '#334155',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontWeight: '600',
                    fontSize: '1rem'
                  }}
                >
                  <Trash2 /> Clear
                </button>
              </div>

              {showColorPicker && (
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(5, 1fr)',
                  gap: '10px',
                  marginTop: '10px'
                }}>
                  {COLORS.map(color => (
                    <button
                      key={color}
                      onClick={() => {
                        setCurrentColor(color);
                        setIsEraser(false);
                        setShowColorPicker(false);
                      }}
                      style={{
                        width: '100%',
                        aspectRatio: '1',
                        background: color,
                        border: currentColor === color ? '3px solid #667eea' : '2px solid #e2e8f0',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        transition: 'transform 0.2s'
                      }}
                    />
                  ))}
                </div>
              )}

              <div style={{ marginTop: '15px' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '8px',
                  fontWeight: '600',
                  color: '#334155',
                  fontSize: '0.9rem'
                }}>
                  Brush Size: {brushSize}px
                </label>
                <input
                  type="range"
                  min="1"
                  max="20"
                  value={brushSize}
                  onChange={(e) => setBrushSize(Number(e.target.value))}
                  style={{
                    width: '100%',
                    accentColor: '#667eea'
                  }}
                />
              </div>
            </div>
          )}

          {/* Guessing interface (for guesser only) */}
          {!isDrawer && (
            <div style={{
              background: 'white',
              borderRadius: '16px',
              padding: '15px',
              marginBottom: '10px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>
              <div style={{ marginBottom: '15px' }}>
                <div style={{
                  maxHeight: '120px',
                  overflowY: 'auto',
                  marginBottom: '10px',
                  padding: '10px',
                  background: '#f8fafc',
                  borderRadius: '12px'
                }}>
                  {messages.length === 0 ? (
                    <p style={{ color: '#94a3b8', fontSize: '0.9rem', textAlign: 'center' }}>
                      Your guesses will appear here...
                    </p>
                  ) : (
                    messages.map((msg, i) => (
                      <div
                        key={i}
                        style={{
                          padding: '8px 12px',
                          marginBottom: '6px',
                          background: msg.isCorrect ? '#dcfce7' : 'white',
                          border: msg.isCorrect ? '2px solid #22c55e' : '1px solid #e2e8f0',
                          borderRadius: '8px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                      >
                        {msg.isCorrect && <Check />}
                        <span style={{
                          fontWeight: '600',
                          color: '#334155',
                          fontSize: '0.85rem'
                        }}>
                          {msg.player}: {msg.text}
                        </span>
                      </div>
                    ))
                  )}
                </div>
              </div>

              <div style={{ display: 'flex', gap: '10px' }}>
                <input
                  type="text"
                  value={guess}
                  onChange={(e) => setGuess(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && submitGuess()}
                  placeholder="Type your guess..."
                  style={{
                    flex: 1,
                    padding: '14px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '12px',
                    fontSize: '1rem',
                    outline: 'none',
                    boxSizing: 'border-box'
                  }}
                />
                <button
                  onClick={submitGuess}
                  style={{
                    padding: '14px 20px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    fontWeight: '700',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontSize: '1rem'
                  }}
                >
                  <MessageCircle /> Guess
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DrawingGame />);
  </script>
</body>
</html>
